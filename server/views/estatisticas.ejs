<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstatÃ­sticas - Agrovale</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Agrovale</h2>
    <ul>
      <li><a href="/dashboard">ğŸ  InÃ­cio</a></li>
      <li><a href="/produtos">ğŸ“¦ Produtos</a></li>
      <li><a href="/vendas">ğŸ’° Vendas</a></li>
      <li><a href="/estatisticas" class="active">ğŸ“Š EstatÃ­sticas</a></li>
      <li><a href="/clientes">ğŸ‘¤ Clientes</a></li>
      <li><a href="/relatorios/auditoria">ğŸ§¾ Auditoria</a></li>
      <li><a href="/logout">ğŸšª Sair</a></li>
    </ul>
  </div>

  <div class="content">
    <header><h1>ğŸ“Š EstatÃ­sticas de Vendas</h1></header>

    <!-- ğŸ” Filtro -->
    <form action="/estatisticas" method="GET" class="filter-form">
      <label for="periodo">Filtrar por:</label>
      <select name="periodo" id="periodo" required>
        <option value="dia" <%= filtro === 'dia' ? 'selected' : '' %>>Dia</option>
        <option value="mes" <%= filtro === 'mes' ? 'selected' : '' %>>MÃªs</option>
        <option value="ano" <%= filtro === 'ano' ? 'selected' : '' %>>Ano</option>
      </select>

      <input type="date" name="data" value="<%= dataSelecionada || '' %>">
      <button type="submit" class="btn btn-primary">Aplicar</button>
    </form>

    <!-- ğŸ”¹ Cards de resumo -->
    <section class="cards">
      <div class="card">
        <h3>Total de Vendas</h3>
        <p><%= totalVendas %></p>
      </div>
      <div class="card">
        <h3>Valor Total Vendido</h3>
        <p>R$ <%= (Number(totalValor) || 0).toFixed(2) %></p>
      </div>
      <div class="card">
        <h3>Ticket MÃ©dio</h3>
        <p>R$ <%= ticketMedio.toFixed(2) %></p>
      </div>
    </section>

    <!-- ğŸ”¸ GrÃ¡fico de Pizza -->
    <section class="box">
      <h3>DistribuiÃ§Ã£o por Forma de Pagamento</h3>
      <canvas id="graficoPagamentos" width="400" height="200"></canvas>
    </section>

    <!-- ğŸ”¸ Produtos mais vendidos -->
    <section class="box">
      <h3>Top 5 Produtos Mais Vendidos</h3>
      <% if (topProdutos.length === 0) { %>
        <p>Nenhum produto vendido no perÃ­odo.</p>
      <% } else { %>
        <ul>
          <% topProdutos.forEach(p => { %>
            <li><strong><%= p.nome_produto %></strong> â€” <%= p.qtd %> vendidos</li>
          <% }) %>
        </ul>
      <% } %>
    </section>
  </div>

  <!-- ğŸ“Š Script do GrÃ¡fico -->
  <script>
    // Dados vindos do servidor
    const fp = <%- JSON.stringify(formasPagamento || []) %>;

    if (Array.isArray(fp) && fp.length > 0) {
      const labels = fp.map(f => f.nome || 'â€”');
      const data = fp.map(f => Number(f.total) || 0);

      const ctx = document.getElementById('graficoPagamentos')?.getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: [
                '#007bff', '#28a745', '#ffc107',
                '#dc3545', '#6f42c1', '#17a2b8', '#6610f2'
              ],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: item => `${item.label}: R$ ${Number(item.raw).toFixed(2)}`
                }
              }
            }
          }
        });
      }
    } else {
      const canvas = document.getElementById('graficoPagamentos');
      if (canvas) canvas.style.display = 'none';
    }
  </script>
</body>
</html>
